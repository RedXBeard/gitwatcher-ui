#:kivy 1.8.0
#:import ListAdapter kivy.adapters.listadapter.ListAdapter
#:import Factory kivy.factory.Factory
#:import CodeInput kivy.uix.codeinput.CodeInput
#:import BashSessionLexer pygments.lexers.shell.BashSessionLexer
#:import KIVY_DEFAULT_FONT settings.KIVY_DEFAULT_FONT

#:set default_font_name "assets/fonts/FiraSans-Regular.ttf"
#:set iconic_font_name "assets/fonts/fontawesome-webfont.ttf"
#:set color1 252,255,245,1
#:set color2 209,219,189,1
#:set color3 145,170,157,1
#:set color4 62,96,111,1
#:set color5 25,52,65,1

#:set color_button (0.784, 0.443, 0.216, 1)  # brown
#:set color_button_pressed (0.659, 0.522, 0.431, 1)  # darker brown
#:set color_font   (0.957, 0.890, 0.843, 1)  # off white


<ConfirmPopup>:
    canvas.before:
        Color:
            rgb: .8,.8,.8
        Rectangle:
            id: rectangle
            pos: self.pos
            size: self.size

    cols:1
	CustomLabel:
		text: "[color=000000]%s[/color]"%root.text
		size_hint_y: None
		height: '50dp'
		font_size: 12
		halign: 'left'
	GridLayout:
		cols: 2
		size_hint_y: None
		height: '32sp'
		Button:
			text: 'Yes'
			on_release: root.dispatch('on_answer','yes')
			background_color: .7, .7, 1, .5
		Button:
			text: 'No'
			on_release: root.dispatch('on_answer', 'no')
			background_color: .7, .7, 1, .5

<CustomSpinnerOption@SpinnerOption>:
    background_color: 1.5, 1.5, 1.5, 1
    color: 1, 1, 1, 1
    size_hint: 1.0, None
    height: '25dp'
    font_size: '12dp'
    font_name: default_font_name

<CustomLabel>
    markup: True
    font_name: default_font_name

<SyncButton>
    size_hint: None, None
    width: '60dp'
    height: '20dp'
    font_size: 12
    markup: True
    background_color: 1,1,1,0
    font_name: default_font_name

<MenuButton>
    pos_hint: {'x': 0}
    background_color: .7, .7, 1, 0.3
    font_size: 12
    border: 9,9,9,9
    font_name: iconic_font_name
    halign: 'left'
    text_size: self.width, None
    markup: True
    pressed: False
    on_press: if self.name != "add repo" : root.parent.parent.parent.parent.parent.show_kv(self.name)

<AddRepoButton>
    font_size: 13
    font_name: default_font_name

<RepoDetailButton>
    halign: 'left'
    text_size: self.width, None
    markup: True
    size_hint: (0.1, 1.0)
    padding_x: '5dp'
    font_name: default_font_name

<ChangesDiffButton>
    halign: 'left'
    font_size: 11
    text_size: self.width, None
    markup: True
    font_name: default_font_name

<CommitButton>
    halign: 'center'
    font_size: 12
    text_size: self.width, None
    markup: True
    size_hint: (0.3, 0.05)
    font_name: default_font_name
    background_color: .7, .7, 1, 0.3
    border: 1,1,1,1

<CommitandPushButton>
    halign: 'center'
    font_size: 12
    font_name: default_font_name
    background_color: .7, .7, 1, 0.3
    border: 1, 1, 1, 1
    size_hint: None, None
    width: '30dp'
    height: '20dp'
    pos_hint: {'right':1}
    markup: True

<UnPushedButton>
    halign: 'center'
    font_size: 12
    text_size: self.width, None
    markup: True
    font_name: default_font_name

<HistoryButton>
    markup: True
    font_size: 12
    font_name: default_font_name

<DiffButton>
    font_name: default_font_name
    markup: True

<BranchesItem>
    height: '40sp'
    size_hint_y: None
    orientation: 'vertical'
    BoxLayout:
        orientation: 'horizontal'
        CustomLabel:
            canvas.before:
                Color:
                    rgb: .9,.9,.9
                Rectangle:
                    id: rectangle
                    pos: self.pos
                    size: self.size
            id: repobranchlabel
            text: "[color=202020][size=13][b]%s[/b] : [color=555555]%s[/color][/size][/color]"%(root.name.strip(), root.sha.strip())
            path: ""
            size_hint: None, 1.0
            width: '150dp'
            valign: 'middle'
            halign: 'left'
            padding_x: '10dp'
            text_size: self.width, self.height
            shorten: True
        CustomLabel:
            canvas.before:
                Color:
                    rgb: .9,.9,.9
                Rectangle:
                    id: rectangle
                    pos: self.pos
                    size: self.size
            id: repobranchlabel
            text: "[color=202020][size=13][b]%s[/b]: [color=555555]%s[/color][/size][/color]"%(root.commiter.strip(), root.subject.strip())
            path: ""
            size_hint: 1.0, 1.0
            valign: 'middle'
            halign: 'left'
            padding_x: '10dp'
            text_size: self.width, self.height
            strip: True
            shorten: True

    CustomLabel:
        text: ""
        size_hint_y: None
        height: '3dp'

<DiffItem>
    orientation: 'vertical'
    size_hint_y: 1.0
    canvas.before:
        Color:
            rgb: .8, .8, .8
        Rectangle:
            pos: self.pos
            size: self.size

    textarea: textarea

    DiffButton:
        text: "[color=ffffff][size=11]Show diff of '%s'[/size][/color]"%root.path
        height: '30dp'
        repo_path: root.repo_path
        path: root.path
        text_size: self.width, self.height
        size_hint_y: None
        valign: 'middle'
        padding_x: '5dp'
        height: '20dp'
        background_color: .7, .7, 1, 0.3
        border: 4, 4, 4, 4

    ScrollView:
        CodeInput:
            id: textarea
            padding_x: '5dp'
            font_size: 12
            size_hint: 1.0, None
            height: max(self.minimum_height, self.parent.height)
            cursor: None
            readonly: True
            text: root.diff
            font_name: default_font_name

    CustomLabel:
        canvas.before:
            Color:
                rgb: .9, .9, .9
            Rectangle:
                pos: self.pos
                size: self.size
        size_hint_y: None
        height: '5dp'


<ChangesItem>
    height: '25sp'
    size_hint_y: None
    orientation: 'vertical'
    changesgroup: changesgroup
    filename: filename
    pressed: False
    CustomLabel:
        canvas.before:
            Color:
                rgb: .8, .8, .8
            Rectangle:
                pos: self.pos
                size: self.size

        size_hint: 1.0, None
        height: '3dp'

    BoxLayout:
        id: changesgroup
        canvas.before:
            Color:
                rgba: .9, .9, .9, 1
            Rectangle:
                id: rectangle
                pos: self.pos
                size: self.size

        orientation: 'horizontal'
        checkbox: checkbox.__self__
        filename: filename.__self__
        CheckBox:
            id: checkbox
            active: True
            size_hint_x: None
            width: '20dp'
        ChangesDiffButton:
            id: filename
            text: '[color=777777][size=11][font=assets/fonts/fontawesome-webfont.ttf][/font] %s[/size][/color]'%root.file_name
            repo_path: root.repo_path
            file_name: root.file_name
            padding_x: '5dp'
            markup: True
            background_color: .7, .7, 1, 0
            border: 4,4,4,4


<UnPushedItem>
    height: '25sp'
    size_hint_y: None

    BoxLayout:
        orientation: 'vertical'
        CustomLabel:
            size_hint: 1.0, None
            height: '3dp'
        BoxLayout:
            canvas.before:
                Color:
                    rgb: .8, .8, .8
                Rectangle:
                    id: rectangle
                    pos: self.pos
                    size: self.size
            CustomLabel:
                canvas.before:
                    Color:
                        rgb: .9, .9, .9
                    Rectangle:
                        id: rectangle
                        pos: self.pos
                        size: self.size
                id: unpushedlabel
                text: '[color=202020][size=11][b]%s[/b]:  %s[/size][/color]'%(root.sha, root.subject)
                size_hint: 1.0, 1.0
                valign: 'middle'
                halign: 'left'
                padding_x: '10dp'
                text_size: self.width, self.height
                strip: True
                shorten: True

            UnPushedButton:
                text: '[color=202020][size=10]UnCommit[/size][/color]'
                path: root.path
                sha: root.sha
                padding_x: '5dp'
                markup: True
                background_color: .7, .7, 1, 0.2
                border: 4,4,4,4
                size_hint_x: None
                width: '70dp'

<RepoItem>
    height: '30sp'
    size_hint_y: None
    repobutton: repobutton.__self__
    repobut: repobut.__self__
    BoxLayout:
        id: repobutton
        RepoDetailButton:
            id: repobut
            text: "[color=333333][size=12] [font=assets/fonts/FiraSans-Regular.ttf][b]"+root.repo_name+"[/b][/size][/color]"
            repo_path: root.repo_path
            width: self.height
            background_color: .7, .7, 1, 0.3
            padding_x: '5dp'
            pressed: False
            border: 14,14,14,14
            markup: True
            font_name: iconic_font_name

<RepoHistoryItem>
    height: '40sp'
    size_hint_y: None
    orientation: 'vertical'
    button1: button1
    button2: button2
    button3: button3
    button4: button4
    eachhistory: eachhistory
    pressed: False
    branch_logid: root.branch_logid
    branch_path: root.branch_path
    BoxLayout:
        id: eachhistory
        canvas.before:
            Color:
                rgb: .9,.9,.9
            Rectangle:
                id: rectangle
                pos: self.pos
                size: self.size

        HistoryButton:
            id: button1
            text: "[color=777777][size=14]%s[/size][/color]"%root.branch_logid
            halign: 'left'
            text_size: self.width, self.height-20
            size_hint: None, 1.0
            width: '70dp'
            strip: True
            background_color: .7, .7, 1, 0
            branch_logid: root.branch_logid
            padding_x: '5dp'
        BoxLayout:
            orientation: 'vertical'
            HistoryButton:
                id: button2
                text: "[color=777777][size=13]%s[/size][/color]"%(root.branch_message)
                valign: 'middle'
                halign: 'justify'
                text_size: self.width, self.height
                strip: True
                shorten: True
                padding_x: "5dp"
                background_color: .7, .7, 1, 0
                branch_logid: root.branch_logid
                border: 1,1,1,1
            HistoryButton:
                id: button3
                text: "[size=9][color=777777]%s by %s[/color][/size]"%(root.branch_date, root.branch_commiter)
                valign: 'middle'
                halign: 'justify'
                text_size: self.width, self.height
                strip: True
                shorten: True
                background_color: .7, .7, 1, 0
                branch_logid: root.branch_logid
                border: 1,1,1,1
                padding_x: "5dp"
        HistoryButton:
            id: button4
            text: '[color=777777]%s[/color]'%str(len(root.diff_files))
            branch_logid: root.branch_logid
            size_hint: (None, 1.0)
            width: '50dp'
            width: self.height
            background_color: .7, .7, 1, 0
    CustomLabel:
        text: ""
        size_hint: 1.0, None
        height: '3dp'


<RepoWatcher>:
    canvas.before:
        Color:
            rgb: .8,.8,.8
        Rectangle:
            id: rectangle
            pos: self.pos
            size: self.size

    orientation: 'vertical'
    screen_manager: screen_manager.__self__
    repolstview: repolstview.__self__
    branchlist: branchlist.__self__

    changes_button: changes_button
    history_button: history_button
    branches_button: branches_button
    settings_button: settings_button
    syncbutton: syncbutton

    ProgressBar:
        id: pb
        size_hint_y: None
        height: '3dp'
        value: root.pb.value

    BoxLayout:
        Splitter:
            sizable_from: 'right'
            rescale_with_parent: True
            max_size: self.parent.width
            min_size: 250
            size_hint: (0.3, 1)

            repolstview:repolstview.__self__

            GridLayout:
                cols: 1
                menu_list: menu_list
                repolstview: repolstview.__self__
                BoxLayout:
                    id: menu_list
                    orientation: 'vertical'
                    size_hint: (1.0, 0.2)

                    changes_button: changes_button.__self__
                    history_button: history_button.__self__
                    branches_button: branches_button.__self__
                    settings_button: settings_button.__self__
                    repoadd_button: repoadd_button.__self__
                    reporemove_button: reporemove_button.__self__

                    MenuButton:
                        id: changes_button
                        text: "[color=ffffff] [font=assets/fonts/FiraSans-Bold.ttf]Changes[/font][/color]" #changes
                        group: "menu"
                        background_color: .7, .7, 1, 0.5
                        pressed: True
                        padding_x: '5dp'
                        name: "Changes"

                    MenuButton:
                        id: history_button
                        text: "[color=222222] [font=assets/fonts/FiraSans-Bold.ttf]History[/font][/color]" #history
                        group: "menu"
                        padding_x: '5dp'
                        name: "History"

                    MenuButton:
                        id: branches_button
                        text: "[color=222222] [font=assets/fonts/FiraSans-Bold.ttf]Branches[/font][/color]" #branches
                        group: "manu"
                        padding_x: '5dp'
                        name: "Branches"

                    MenuButton:
                        id: settings_button
                        text: "[color=222222] [font=assets/fonts/FiraSans-Bold.ttf]Settings[/font][/color]" #settings
                        group: "menu"
                        padding_x: '5dp'
                        name: "Settings"

                CustomLabel:
                    size_hint_y: None
                    height: '30dp'

                BoxLayout:
                    orientation: 'horizontal'
                    size_hint: (1.0, 0.05)
                    repoadd_button: repoadd_button
                    reporemove_button: reporemove_button

                    MenuButton:
                        id: repoadd_button
                        size_hint: (None, 1.0)
                        width: '20dp'
                        text: "" #add
                        valign: 'middle'
                        halign: 'center'
                        popup: popup.__self__

                        on_release: popup.open()

                        Popup:
                            name: "popup1"
                            id: popup
                            title: "Add Existing Repo"
                            size_hint: None, None
                            size: 400, 140
                            repobox: repobox.__self__

                            on_parent:
                                if self.parent == repoadd_button : self.parent.remove_widget(self)

                            BoxLayout:
                                canvas.before:
                                    Color:
                                        rgb: .8,.8,.8
                                    Rectangle:
                                        id: rectangle
                                        pos: self.pos
                                        size: self.size
                                name: "repo addition"
                                id: repobox
                                orientation: 'vertical'
                                size_hint: (1.0, 1.0)
                                padding: '5dp'
                                repoaddbox: repoaddbox.__self__

                                Label:
                                    size_hint: 1.0, None
                                    height: '5dp'

                                BoxLayout:
                                    name: "repo add box"
                                    id: repoaddbox
                                    repopath: ti_path.__self__
                                    size_hint: (1, None)
                                    height: '32dp'
                                    TextInput:
                                        id: ti_path
                                        size_hint_y: None
                                        height: '32dp'
                                        hint_text: 'repo path'
                                        text: ""
                                    Button:
                                        id: repofolder
                                        text: "[color=000000]Choose..[/color]"
                                        font_size: 13
                                        size_hint: (0.5,None)
                                        height: '32dp'
                                        file_popup: file_popup.__self__
                                        background_color: .7, .7, 1, .5
                                        markup: True
                                        on_release: popup.dismiss(); file_popup.open()

                                        Popup:
                                            id: file_popup
                                            name: "file_popup"
                                            title: "Find Repo"
                                            size_hint: None, None
                                            size: 500, 400
                                            listing: listing.__self__

                                            on_parent:
                                                if self.parent == repofolder: self.parent.remove_widget(self)

                                            BoxLayout:
                                                id: listing
                                                name: "filelist"
                                                listview: listview.__self__

                                                FileChooserListView:
                                                    id: listview
                                                    dirselect: True
                                                AddRepoButton:
                                                    name: "folderchoser"
                                                    id: folderchoser
                                                    text: "[color=000000]Choose[/color]"
                                                    size_hint: (0.2, 1)
                                                    background_color: .7, .7, 1, .5
                                                    markup: True
                                                    on_release:
                                                        file_popup.dismiss(); root.load_repo()

                                Label:
                                    size_hint: 1.0, None
                                    height: '5dp'

                                BoxLayout:
                                    orientation: 'horizontal'
                                    size_hint: (1, None)
                                    height: '32dp'
                                    spacing: 122

                                    AddRepoButton:
                                        id: repoaddbut
                                        text: "[color=000000]Add Repo[/color]"
                                        background_color: .7, .7, 1, .5
                                        markup: True
                                        font_size: 13
                                    Button:
                                        text: "[color=000000]Cancel[/color]"
                                        font_size: 13
                                        on_release: popup.dismiss()
                                        background_color: .7, .7, 1, .5
                                        markup: True


                    CustomSpinner:
                        id: branchlist
                        text: "" #branch
                        values: []
                        path: ""
                        markup: True
                        font_name: iconic_font_name
                        font_size: 13
                        background_color: .7, .7, 1, 0.3
                        size_hint: (1.0, 1.0)
                        size_x: len(self.text)
                        border: 10,10,10,10
                        option_cls: Factory.get("CustomSpinnerOption")

                    MenuButton:
                        id: reporemove_button
                        size_hint: (None, 1.0)
                        width: '20dp'
                        text: "" #remove
                        halign: 'center'
                        valign: 'middle'

                BoxLayout:
                    orientation: 'horizontal'
                    size_hint_y: None
                    height: '20dp'
                    CustomLabel:
                        text: '[color=222222][size=13][b][font=assets/fonts/fontawesome-webfont.ttf][/font] Repositories[/b][/size][/color]'
                        size_hint: 1.0, None
                        height: '20dp'
                        halign: 'left'
                        valign: 'bottom'
                        text_size: self.width, self.height
                        padding_x: '5dp'
                    SyncButton:
                        id: syncbutton
                        text: '[color=CECFC6][font=assets/fonts/fontawesome-webfont.ttf][/font] Sync[/color]'
                        path: ''

                ListView:
                    id: repolstview
                    adapter: ListAdapter(data=root.repos, cls=Factory.RepoItem, args_converter=root.args_converter)

        ScreenManager:
            id: screen_manager
            size_hint: (0.8, 1)
            Screen:
                size_hint: (1, 1)
                name: "Changes"
                ChangesMenu:
            Screen:
                size_hint: (1, 1)
                name: "History"
                HistoryMenu:
            Screen:
                size_hint: (1, 1)
                name: "Branches"
                BranchesMenu:
            Screen:
                size_hint: (1, 1)
                name: "Settings"
                SettingsMenu:
            Screen:
                size_hint: (1, 1)
                name: "FileDiff"
                FileDiff: