#:kivy 1.8.0
#:import ListAdapter kivy.adapters.listadapter.ListAdapter
#:import Factory kivy.factory.Factory
#:import CodeInput kivy.uix.codeinput.CodeInput
#:import KIVY_DEFAULT_FONT settings.KIVY_DEFAULT_FONT

#:set default_font_name "assets/fonts/FiraSans-Regular.ttf"
#:set iconic_font_name "assets/fonts/fontawesome-webfont.ttf"
#:set color1 252,255,245,1
#:set color2 209,219,189,1
#:set color3 145,170,157,1
#:set color4 62,96,111,1
#:set color5 25,52,65,1

<Popup>
    canvas.before:
        Color:
            rgb: .9,.9,.9
        Rectangle:
            id: rectangle
            pos: self.pos
            size: self.size

<CustomLabel>
    markup: True

<MenuButton>
    pos_hint: {'x': 0}
    background_color: .7, .7, 1, 0.3
    font_size: 12
    border: 9,9,9,9
    font_name: iconic_font_name
    halign: 'left'
    text_size: self.width, None
    markup: True
    pressed: False
    on_press: if self.name != "add repo" : root.parent.parent.parent.parent.show_kv(self.name)

<AddRepoButton>
    font_size: 13

<RepoDetailButton>
    halign: 'left'
    text_size: self.width, None
    markup: True
    size_hint: (0.1, 1.0)
    padding_x: '-5dp'
    font_name: default_font_name

<ChangesDiffButton>
    halign: 'left'
    font_size: 11
    text_size: self.width, None
    markup: True
    font_name: default_font_name

<CommitButton>
    halign: 'center'
    font_size: 12
    text_size: self.width, None
    markup: True
    size_hint: (0.3, 0.05)
    font_name: default_font_name
    background_color: .7, .7, 1, 0.3
    border: 1,1,1,1

<CommitandPushButton>
    halign: 'center'
    font_size: 12
    font_name: default_font_name
    background_color: .7, .7, 1, 0.3
    border: 1, 1, 1, 1
    size_hint: None, None
    width: '30dp'
    height: '20dp'
    pos_hint: {'right':1}
    markup: True

<UnPushedButton>
    halign: 'center'
    font_size: 12
    text_size: self.width, None
    markup: True
    font_name: default_font_name

<HistoryButton>
    font_size: 12

<BranchesItem>
    height: '40sp'
    size_hint_y: None
    orientation: 'vertical'
    BoxLayout:
        orientation: 'horizontal'
        CustomLabel:
            canvas.before:
                Color:
                    rgb: .9,.9,.9
                Rectangle:
                    id: rectangle
                    pos: self.pos
                    size: self.size
            id: repobranchlabel
            text: "[color=202020][size=13][b]%s[/b]\n[color=555555]%s[/color][/size][/color]"%(root.name.strip(), root.sha.strip())
            path: ""
            size_hint: None, 1.0
            width: '100dp'
            valign: 'top'
            halign: 'left'
            padding_x: '-10dp'
            text_size: self.width, self.height
            shorten: True
        CustomLabel:
            canvas.before:
                Color:
                    rgb: .9,.9,.9
                Rectangle:
                    id: rectangle
                    pos: self.pos
                    size: self.size
            id: repobranchlabel
            text: "[color=202020][size=13][b]%s[/b]: [color=555555]%s[/color][/size][/color]"%(root.commiter.strip(), root.subject.strip())
            path: ""
            size_hint: 1.0, 1.0
            valign: 'middle'
            halign: 'left'
            padding_x: '-10dp'
            text_size: self.width, self.height
            strip: True
            shorten: True

    CustomLabel:
        text: ""
        size_hint_y: None
        height: '3dp'


<ChangesItem>
    height: '25sp'
    size_hint_y: None
    orientation: 'vertical'
    changesgroup: changesgroup.__self__

    CustomLabel:
        canvas.before:
            Color:
                rgb: .8, .8, .8
            Rectangle:
                id: rectangle
                pos: self.pos
                size: self.size

        size_hint: 1.0, None
        height: '3dp'

    BoxLayout:
        id: changesgroup
        canvas.before:
            Color:
                rgba: .7, .7, .75, 0.5
            Rectangle:
                id: rectangle
                pos: self.pos
                size: self.size

        orientation: 'horizontal'
        checkbox: checkbox.__self__
        filename: filename.__self__
        CheckBox:
            id: checkbox
            active: True
            size_hint_x: None
            width: '20dp'
        ChangesDiffButton:
            id: filename
            text: '[color=202020][size=10][font=assets/fonts/fontawesome-webfont.ttf][/font] %s[/size][/color]'%root.file_name
            repo_path: root.repo_path
            file_name: root.file_name
            padding_x: '-5dp'
            markup: True
            background_color: .7, .7, 1, 0
            border: 4,4,4,4


<UnPushedItem>
    height: '25sp'
    size_hint_y: None

    BoxLayout:
        orientation: 'vertical'
        CustomLabel:
            size_hint: 1.0, None
            height: '3dp'
        BoxLayout:
            canvas.before:
                Color:
                    rgb: .8, .8, .8
                Rectangle:
                    id: rectangle
                    pos: self.pos
                    size: self.size
            CustomLabel:
                canvas.before:
                    Color:
                        rgb: .9, .9, .9
                    Rectangle:
                        id: rectangle
                        pos: self.pos
                        size: self.size
                id: unpushedlabel
                text: '[color=202020][size=11][b]%s[/b]:  %s[/size][/color]'%(root.sha, root.subject)
                size_hint: 1.0, 1.0
                valign: 'middle'
                halign: 'left'
                padding_x: '-10dp'
                text_size: self.width, self.height
                strip: True
                shorten: True

            UnPushedButton:
                text: '[color=202020][size=10]UnCommit[/size][/color]'
                path: root.path
                sha: root.sha
                padding_x: '-5dp'
                markup: True
                background_color: .7, .7, 1, 0.2
                border: 4,4,4,4
                size_hint_x: None
                width: '70dp'

<RepoItem>
    height: '30sp'
    size_hint_y: None
    repobutton: repobutton.__self__

    BoxLayout:
        id: repobutton
        RepoDetailButton:
            text: "[color=333333][b][size=12]%s[/size][/b][/color]"%root.repo_name
            repo_path: root.repo_path
            width: self.height
            background_color: .7, .7, 1, 0.3
            padding_x: '-5dp'
            pressed: False
            border: 14,14,14,14
            markup: True

<RepoHistoryItem>
    height: '40sp'
    size_hint_y: None
    orientation: 'vertical'

    BoxLayout:
        canvas.before:
            Color:
                rgb: .9,.9,.9
            Rectangle:
                id: rectangle
                pos: self.pos
                size: self.size
        hselect:hselect.__self__
        CustomLabel:
            text: "[color=000000][size=14]%s[/size][/color]"%root.branch_logid
            halign: 'left'
            text_size: self.width, self.height-20
            size_hint: None, 1.0
            width: '70dp'
            strip: True
            padding_x: '-5dp'
        BoxLayout:
            orientation: 'vertical'
            CustomLabel:
                text: "[color=333333][size=13]%s[/size][/color]"%(root.branch_message)
                valign: 'middle'
                halign: 'justify'
                text_size: self.width, self.height
                strip: True
                shorten: True
                padding_x: -.5
            CustomLabel:
                text: "[size=9][color=919299]%s by %s[/color][/size]"%(root.branch_date, root.branch_commiter)
                valign: 'middle'
                halign: 'justify'
                text_size: self.width, self.height
                strip: True
                shorten: True
        HistoryButton:
            id: hselect
            text: '[color=333333]%s[/color]'%str(len(root.diff_files))
            markup: True
            branch_logid: root.branch_logid
            size_hint: (None, 1.0)
            width: '50dp'
            width: self.height
            background_color: .7, .7, 1, 0.3
            on_release: root.parent.parent.parent.parent.parent.parent.load_diff(root.branch_path, root.branch_logid)
    CustomLabel:
        text: ""
        size_hint: 1.0, None
        height: '3dp'


<RepoWatcher>:
    canvas.before:
        Color:
            rgb: .8,.8,.8
        Rectangle:
            id: rectangle
            pos: self.pos
            size: self.size

    rows: 1
    screen_manager: screen_manager.__self__
    repolstview: repolstview.__self__
    branchlist: branchlist.__self__

    changes_button: changes_button
    history_button: history_button
    branches_button: branches_button
    settings_button: settings_button

    Splitter:
        sizable_from: 'right'
        rescale_with_parent: True
        max_size: self.parent.height
        size_hint: (0.3, 1)

        repolstview:repolstview.__self__

        GridLayout:
            cols: 1
            menu_list: menu_list
            BoxLayout:
                orientation: 'horizontal'
                size_hint: (1.0, 0.05)
                repoadd_button: repoadd_button

                MenuButton:
                    id: repoadd_button
                    size_hint: (0.1, 1.0)
                    text: "" #add
                    group: "menu"
                    halign: 'center'
                    popup: popup.__self__
                    name: "add repo"

                    on_release: popup.open()

                    Popup:
                        name: "popup1"
                        id: popup
                        title: "Add Existing Repo"
                        size_hint: None, None
                        size: 400, 130
                        repobox: repobox.__self__

                        on_parent:
                            if self.parent == repoadd_button : self.parent.remove_widget(self)

                        BoxLayout:
                            name: "repo addition"
                            id: repobox
                            orientation: 'vertical'
                            size_hint: (1.0, 1.0)
                            padding: '5dp'
                            repoaddbox: repoaddbox.__self__

                            BoxLayout:
                                name: "repo add box"
                                id: repoaddbox
                                repopath: ti_path.__self__
                                size_hint: (1, 0.6)
                                TextInput:
                                    id: ti_path
                                    size_hint_y: None
                                    height: '32dp'
                                    hint_text: 'repo path'
                                    text: ""
                                Button:
                                    id: repofolder
                                    text: "Choose.."
                                    font_size: 13
                                    size_hint: (0.5,1)
                                    file_popup: file_popup.__self__

                                    on_release: popup.dismiss(); file_popup.open()

                                    Popup:
                                        id: file_popup
                                        name: "file_popup"
                                        title: "Find Repo"
                                        size_hint: None, None
                                        size: 500, 400
                                        listing: listing.__self__

                                        on_parent:
                                            if self.parent == repofolder: self.parent.remove_widget(self)

                                        BoxLayout:
                                            id: listing
                                            name: "filelist"
                                            listview: listview.__self__

                                            FileChooserListView:
                                                id: listview
                                                dirselect: True
                                            AddRepoButton:
                                                name: "folderchoser"
                                                id: folderchoser
                                                text: "Choose"
                                                size_hint: (0.2, 1)
                                                on_release:
                                                    file_popup.dismiss(); root.load_repo()
                            BoxLayout:
                                orientation: 'horizontal'
                                size_hint: (1, 0.5)
                                spacing: 120

                                AddRepoButton:
                                    id: repoaddbut
                                    text: "Add Repo"
                                Button:
                                    text: "Cancel"
                                    font_size: 13
                                    on_release: popup.dismiss()


                Spinner:
                    id: branchlist
                    text: "" #branch
                    values: []
                    path: ""
                    markup: True
                    font_name: iconic_font_name
                    font_size: 13
                    background_color: .7, .7, 1, 0.3
                    size_hint: (1.0, 1.0)
                    size_x: len(self.text)
                    on_text: root.change_branch(args[1], self.path)
                    border: 11,11,11,11

            CustomLabel:
                text: '[color=222222][size=13][b]Repositories[/b][/size][/color]'
                size_hint: 1.0, None
                height: '20dp'
                halign: 'left'
                valign: 'bottom'
                text_size: self.width, self.height
                padding_x: '-5dp'

            ListView:
                id: repolstview
                adapter: ListAdapter(data=root.repos, cls=Factory.RepoItem, args_converter=root.args_converter)

            BoxLayout:
                id: menu_list
                orientation: 'vertical'
                size_hint: (1.0, 0.2)

                changes_button: changes_button.__self__
                history_button: history_button.__self__
                branches_button: branches_button.__self__
                settings_button: settings_button.__self__

                MenuButton:
                    id: changes_button
                    text: "[color=ffffff] [font=assets/fonts/FiraSans-Bold.ttf]Changes[/font][/color]" #changes
                    group: "menu"
                    background_color: .7, .7, 1, 0.5
                    pressed: True
                    padding_x: '-5dp'
                    name: "Changes"

                MenuButton:
                    id: history_button
                    text: "[color=222222] [font=assets/fonts/FiraSans-Bold.ttf]History[/font][/color]" #history
                    group: "menu"
                    padding_x: '-5dp'
                    name: "History"

                MenuButton:
                    id: branches_button
                    text: "[color=222222] [font=assets/fonts/FiraSans-Bold.ttf]Branches[/font][/color]" #branches
                    group: "manu"
                    padding_x: '-5dp'
                    name: "Branches"

                MenuButton:
                    id: settings_button
                    text: "[color=222222] [font=assets/fonts/FiraSans-Bold.ttf]Settings[/font][/color]" #settings
                    group: "menu"
                    padding_x: '-5dp'
                    name: "Settings"

    ScreenManager:
        id: screen_manager
        size_hint: (0.8, 1)
        Screen:
            size_hint: (1, 1)
            name: "Changes"
            ChangesMenu:
        Screen:
            size_hint: (1, 1)
            name: "History"
            HistoryMenu:
        Screen:
            size_hint: (1, 1)
            name: "Branches"
            BranchesMenu:
        Screen:
            size_hint: (1, 1)
            name: "Settings"
            SettingsMenu:
