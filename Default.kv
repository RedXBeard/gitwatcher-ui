#:kivy 1.8.0
#:import ListAdapter kivy.adapters.listadapter.ListAdapter
#:import Factory kivy.factory.Factory
#:import CodeInput kivy.uix.codeinput.CodeInput

#:set default_font_name "assets/fonts/FiraSans-Regular.ttf"
#:set iconic_font_name "assets/fonts/fontawesome-webfont.ttf"
#:set color1 252,255,245,1
#:set color2 209,219,189,1
#:set color3 145,170,157,1
#:set color4 62,96,111,1
#:set color5 25,52,65,1

<MenuButton>
    pos_hint: {'x': 0}
    background_color: 2,2,2,9
    font_size: self.height/2
    border: 9,9,9,9
    font_name: iconic_font_name

<AddRepoButton>
    font_size: 13

<RepoDetailButton>
    front_size: 13
    halign: 'left'
    text_size: self.width, None
    markup: True

<HistoryButton>
    font_size: 13

<RepoItem>
    height: '30sp'
    size_hint_y: None
    repobutton: repobutton.__self__

    BoxLayout:
        id: repobutton
        spacing:
        RepoDetailButton:
            text: "%s"%root.repo_name
            repo_path: root.repo_path
            width: self.height
            background_color: .7, .7, 1, 1
            on_release: root.parent.parent.parent.parent.parent.parent.load_history(self.repo_path)
            padding_x: '-5dp'

<RepoHistoryItem>
    height: '40sp'
    size_hint_y: None
    canvas:
        Color:
            rgb: .3, .3, .3
        Rectangle:
            pos: self.pos
            size: self.width, 1

    BoxLayout:
        hselect:hselect.__self__
        Label:
            text: "[color=000000][size=15]%s[/size][/color]"%root.branch_logid
            markup: True
            halign: 'left'
            text_size: self.width, self.height-20
            size_hint: (0.2,1.0)
            strip: True
        Label:
            text: "[color=333333][size=13]%s[/size][/color]\n[size=9][color=919299]%s by %s[/color][/size]"%(root.branch_message, root.branch_date, root.branch_commiter)
            markup: True
            valign: 'top'
            halign: 'left'
            text_size: self.width, self.height
            strip: True
            shorten: True
            padding_x: -.5
            max_lines: 2
        HistoryButton:
            id: hselect
            text: ">"
            branch_logid: root.branch_logid
            size_hint: (0.05, 1.0)
            width: self.height
            background_color: .7, .7, 1, 1
            on_release: root.parent.parent.parent.parent.parent.parent.load_diff(root.branch_path, root.branch_logid)

<RepoWatcher>:
    cols: 1
    name: "ROOT"
    menu: menu_box.__self__
    repo: repo_box.__self__

    canvas.before:
        Color:
            rgb: .9,.9,.9
        Rectangle:
            pos: self.pos
            size: self.size

    BoxLayout:
        id: menu_box
        orientation: 'horizontal'
        size_hint: (1.0, 0.05)
        spacing: 1

        addrepo: repoadd_button.__self__
        history: history_button.__self__
        branches: branches_button.__self__
        changes: changes_button.__self__
        settings: settings_button.__self__
        branchlist: branchlist.__self__

        MenuButton:
            id: repoadd_button
            size_hint: (0.2, 1.0)
            text: "" #add
            group: "menu"
            popup: popup.__self__

            on_release: popup.open()

            Popup:
                name: "popup1"
                id: popup
                title: "Add Existing Repo"
                size_hint: None, None
                size: 400, 130
                repobox: repobox.__self__

                on_parent:
                    if self.parent == repoadd_button : self.parent.remove_widget(self)

                BoxLayout:
                    name: "repo addition"
                    id: repobox
                    orientation: 'vertical'
                    size_hint: (1.0, 1.0)
                    padding: '5dp'
                    repoaddbox: repoaddbox.__self__

                    BoxLayout:
                        name: "repo add box"
                        id: repoaddbox
                        repopath: ti_path.__self__
                        size_hint: (1, 0.6)
                        TextInput:
                            id: ti_path
                            size_hint_y: None
                            height: '32dp'
                            hint_text: 'repo path'
                            text: ""
                        Button:
                            id: repofolder
                            text: "Choose.."
                            font_size: 13
                            size_hint: (0.5,1)
                            file_popup: file_popup.__self__

                            on_release: popup.dismiss(); file_popup.open()

                            Popup:
                                id: file_popup
                                name: "file_popup"
                                title: "Find Repo"
                                size_hint: None, None
                                size: 500, 400
                                listing: listing.__self__

                                on_parent:
                                    if self.parent == repofolder: self.parent.remove_widget(self)

                                BoxLayout:
                                    id: listing
                                    name: "filelist"
                                    listview: listview.__self__

                                    FileChooserListView:
                                        id: listview
                                        dirselect: True
                                    AddRepoButton:
                                        name: "folderchoser"
                                        id: folderchoser
                                        text: "Choose"
                                        size_hint: (0.2, 1)
                                        on_release:
                                            file_popup.dismiss(); root.load_repo();\
                                            root.repo.s_repo.repolstview.adapter = ListAdapter(data=root.repos, cls=Factory.RepoItem, args_converter=root.args_converter)

                    BoxLayout:
                        orientation: 'horizontal'
                        size_hint: (1, 0.5)
                        spacing: 120

                        AddRepoButton:
                            id: repoaddbut
                            text: "Add Repo"
                        Button:
                            text: "Cancel"
                            font_size: 13
                            on_release: popup.dismiss()

        Spinner:
            id: branchlist
            text: "" #branch
            values: []
            path: ""
            font_name: iconic_font_name
            font_size: 13
            background_color: 2,2,2,9
            size_hint: (None, 1.0)
            size_x: len(self.text)
            on_text: root.change_branch(args[1], self.path)

        MenuButton:
            id: history_button
            text: "" #history
            group: "menu"

        MenuButton:
            id: branches_button
            text: "" #branches
            group: "manu"

        MenuButton:
            id: changes_button
            text: "" #changes
            group: "menu"

        MenuButton:
            id: settings_button
            text: "" #settings
            group: "menu"

    BoxLayout:
        id: repo_box
        orientation: 'horizontal'
        s_repo: split_repo.__self__
        textarea:textarea.__self__
        textscroll: textscroll.__self__
        Splitter:
            id: split_repo

            sizable_from: 'right'
            rescale_with_parent: True
            max_size: self.parent.width

            repolstview:repolstview.__self__

            ListView:
                id: repolstview
                adapter: ListAdapter(data=root.repos, cls=Factory.RepoItem, args_converter=root.args_converter)

        Splitter:
            sizable_from: 'right'
            rescale_with_parent: True
            max_size: self.parent.width

            repodetail: repodetail.__self__
            ListView
                id: repodetail
                adapter: ListAdapter(data=root.history, cls=Factory.RepoHistoryItem, args_converter=root.history_args_converter)

        ScrollView:
            id: textscroll
            textarea: textarea.__self__
            do_scroll_y: True
            size_hint: 1, 1
            bar_pos_x: 'top'
            Label:
                id: textarea
                padding_x: '-5dp'
                text: ''
                font_size: 12
                readonly: True
                valign: 'top'
                markup: True
                text_size: self.parent.width, self.height
                size_hint: 1, None
                height: len(self.text)
